<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <title>World Crude Oil Trade</title>
  <style>

  body { 
    font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
    font-color: "#fff";
  }

  .ticks {
    font: 10px sans-serif;
  }

  .track,
  .track-inset,
  .track-overlay {
    stroke-linecap: round;
  }

  .track {
    stroke: #000;
    stroke-opacity: 0.3;
    stroke-width: 10px;
  }

  .track-inset {
    stroke: #ddd;
    stroke-width: 8px;
  }

  .track-overlay {
    pointer-events: stroke;
    stroke-width: 50px;
    cursor: crosshair;
  }

  #handle {
    fill: #fff;
    stroke: #000;
    stroke-opacity: 0.5;
    stroke-width: 1.25px;
  }

  .country {
    fill: #ccc;
    stroke: #fff;
    stroke-width: .5px;
    stroke-linejoin: round;
  }

  .country:hover, rect:hover {
    opacity: 0.5;
  }

  .hidden {
    display: none;
  }

  div.tooltip {
    color: #222;
    background-color: #fff;
    padding: .5em;
    text-shadow: #f5f5f5 0 1px 0;
    border-radius: 2px;
    opacity: 0.9;
    position: absolute;
  }

  </style>
  <script src="http://d3js.org/d3.v4.min.js"></script>
  <script src="https://d3js.org/d3-geo-projection.v1.min.js"></script>
  <script src="http://d3js.org/topojson.v2.min.js"></script>
  <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>

</head>

<body>

<h3>World Crude Oil trade</h3>

<form id="controls">

  <label><input type="radio" name="mode" value="imports" > Import</label>
  <label><input type="radio" name="mode" value="exports" id="exports" checked> Export</label>
</form>

<script>

var width = 1000;
var height = 600;

var margin = {
    top: 50,
    right: 50,
    bottom: 50,
    left: 50};

var svg = d3.select("body").append("svg")
  .attr("id", "worldMap")
  .attr("width", width)
  .attr("height", height);
  // .style("background-color", "#deebf7");

var svgSlider = d3.select("body").append("svg")
  .attr("id", "slidertest")
  .attr("width", 1200)
  .attr("height", 80);

var svgTreemap = d3.select("body").append("svg")
  .attr("id", "Treemap")
  .attr("width", 1200)
  .attr("height", 1200);

var tooltip = d3.select('body').append('div')
      .attr('class', 'hidden tooltip');

// Color function for treemap squares
var colorTreemap = d3.scaleLinear()
    .domain([0, 12332145000])
    .range(["#D3D3D3", "#939393", "black"]);

var format = d3.format(",d");

/*----------------------- MAP PART -----------------------*/
var projection = d3.geoWinkel3()
  .scale(width / 2 / Math.PI)
  .translate([width / 2, height / 2])

var path = d3.geoPath()
  .projection(projection);

var colorMap = d3.scaleLinear()
  .domain([100, 1000])
  .range(d3.schemeBlues[5])

var dictCountries = {};

var treemap = d3.treemap()
  .tile(d3.treemapResquarify)
  .size([500, 500])
  .padding(1)
  .round(true);

d3.queue()
    .defer(d3.json, 'world-50m-cc.json')
    .defer(d3.json, 'imports.json')
    .defer(d3.json, 'exports.json')
    .defer(d3.json, 'data.json')
    .defer(d3.json, 'treemaptest.json')
    .await(ready)

/* ---------------------------------------------- WHEN DATA IS READY ----------------------------------------------*/
function ready(error, world, imports, exports, data) {
  if (error) throw error;

    // Start values
  trade = exports;
  year = 2013;
  var country;

  // Default is exports in 2013
  updateMap(trade, year)

/* ----------------------- RADIO BUTTON TOGGLE -----------------------*/
  // Select import or export with radio button
  var inputElems = d3.selectAll("input")
    .on("change", function() {
      var inputValue = this.value;

      if (inputValue === "imports") { trade = imports; console.log("imports")}
      else { trade = exports; console.log("exports")} 

      updateMap(trade, year)
      if (!(country === undefined)) {updateTreemap(country, year, trade)}
      // else {console.log("country not defined yet")}
    })

 /*----------------------- YEAR SLIDER -----------------------*/
  var x = d3.scaleLinear()
    .domain([1960, 2013])
    .range([0, width])
    .clamp(true);

  var slider = svgSlider.append("g")
    .attr("class", "slider")
    .attr("transform", "translate(" + margin.left + "," + 100 / 2 + ")");

  slider.append("line")
    .attr("class", "track")
    .attr("x1", x.range()[0])
    .attr("x2", x.range()[1])
  .select(function() { return this.parentNode.appendChild(this.cloneNode(true)); })
    .attr("class", "track-inset")
  .select(function() { return this.parentNode.appendChild(this.cloneNode(true)); })
    .attr("class", "track-overlay")
    .call(d3.drag()
        .on("start.interrupt", function() { slider.interrupt(); })
        .on("start drag", function() { updateSliderCircle(x.invert(d3.event.x)) ; }));

  slider.insert("g", ".track-overlay")
      .attr("class", "ticks")
      .attr("transform", "translate(0," + 18 + ")")
    .selectAll("text")
    .data(x.ticks(18))
    .enter().append("text")
      .attr("x", x)
      .attr("text-anchor", "middle")
      .text(function(d) { return d; });

  var handle = slider.insert("circle", ".track-overlay")
    .attr("id", "handle")
    .attr("r", 7)
    .attr("cx", x(2013));

  function updateSliderCircle(h) {
      handle.attr("cx", x(h));

      year = parseInt(h);

      if (document.getElementById('exports').checked) { trade = exports; console.log("exports");}
      else { trade = imports; console.log("imports");}
      updateMap(trade, year);

      if (country) {updateTreemap(country, year, trade); console.log("Slider updating treemap")};
      // changeYear(year)
  }


  /* ----------------------- TREEMAP PART -----------------------*/
  function updateTreemap(selectedCountry, selectedYear, tradedata) {
    // §§§§§§ TODO §§§§§§: Draw a title with selectedCountry, selectedYear

    d3.select("#Treemap").append("te")

    // Remove previous treemap
    d3.select("#Treemap").selectAll("g").remove();

    console.log(selectedCountry, selectedYear)

    // country = selectedCountry
    treemapData = data[selectedCountry][selectedYear]

    // console.log("treemapData:", treemapData)

    // Constructs a root node from the specified hierarchical data. The specified data must be an object representing the root node.
    if (tradedata === imports) {
        console.log("treemap for imports")

        root = d3.hierarchy(treemapData)
            .sum(function(d) { return d.import; });

        treemap(root)

        console.log("tm'ed root", root)

        square = svgTreemap.selectAll("g")
          .data(root.leaves()) //Join the data
          .enter().append("g")
            .attr("transform", function(d) { return "translate(" + d.x0 + "," + d.y0 + ")" }); 

        square.append("rect")
          .attr("id", function(d) { return d.data.country; })
          .attr("width", function(d) { return d.x1 - d.x0; })
          .attr("height", function(d) { return d.y1 - d.y0; })
          .attr("fill", function(d) { return colorTreemap(d.data.import); });

        square.append("title")
            .text(function(d) { return d.data.country + "\n" + format(d.data.import); })
    } else {
          console.log("treemap for exports")

          root = d3.hierarchy(treemapData)
              .sum(function(d) { return d.export; });

          treemap(root)

          console.log("tm'ed root", root)

          square = svgTreemap.selectAll("g")
            .data(root.leaves()) //Join the data
            .enter().append("g")
              .attr("transform", function(d) { return "translate(" + d.x0 + "," + d.y0 + ")" }); 

          square.append("rect")
            .attr("id", function(d) { return d.data.country; })
            .attr("width", function(d) { return d.x1 - d.x0; })
            .attr("height", function(d) { return d.y1 - d.y0; })
            .attr("fill", function(d) { return colorTreemap(d.data.export); });

          square.append("title")
              .text(function(d) { return d.data.country + "\n" + format(d.data.export); });
    }

    square.append("clipPath")
      .attr("id", function(d) { return "clip-" + d.data.country; })
     .append("use")
      .attr("xlink:href", function(d) { return "#" + d.data.country; });

    square.append("text")
        .attr("clip-path", function(d) { return "url(#clip-" + d.data.country + ")"; })
      .selectAll("tspan")
        .data(function(d) { return d.data.country.split(/(?=[A-Z][^A-Z])/g); })
      .enter().append("tspan")
        .attr("x", 4)
        .attr("y", function(d, i) { return 13 + i * 10; })
        .text(function(d) { return d; });
        // .style("font-size", function(d) {
        //   // compute font size based on sqrt(area)
        //   return Math.max(20, 0.18 * (d.x1 - d.x0)) + 'px'; });
  }

  /* ------ TREEMAP ANIMATION ------*/ 
  // function changeYear(selectedYear) {
  //     var t = d3.transition()
  //       .duration(750);

  //     treemapData = data[country][selectedYear]

  //     console.log("Changed treemapData:", treemapData)

  //     var root = d3.hierarchy(treemapData)
  //       .sum(function(d) { return d.import; });
      
  //     treemap(root);
  //     console.log("new tm'ed root", root)

  //     // Join new data with old elements, if any.
  //     square.data(root.leaves())
      
  //     // EXIT old elements not present in new data.
  //     square.exit()
  //         .attr("class", "exit")
  //       .transition(t)
  //         .attr("y", 60)
  //         .style("fill-opacity", 1e-6)
  //         .remove();

  //     // UPDATE old elements present in new data.
  //     square.enter()
  //       .attr("class", "update")
  //       .transition(t)
  //         .attr("transform", function(d) { return "translate(" + d.x0 + "," + d.y0 + ")"; })
  //       .select("rect")
  //         .attr("width", function(d) { return d.x1 - d.x0; })
  //         .attr("height", function(d) { return d.y1 - d.y0; })

  //     // ENTER new elements present in new data.
  //     square.enter().append("text")
  //         .attr("class", "enter")
  //         .attr("id", function(d) { return d.data.country; })
  //       .transition(t)
  //         .attr("width", function(d) { return d.x1 - d.x0; })
  //         .attr("height", function(d) { return d.y1 - d.y0; })
  //         .attr("fill", function(d) { return colorTreemap(d.data.import); });
  //   }

  /*----------------------- MAP PART -----------------------*/

  // Get countries from map
  var countries = topojson.feature(world, world.objects.countries).features;

  svg.selectAll(".country")
      .data(countries)
    .enter().insert("path")
      .attr("class", "country")
      .attr("id", function (d) { return d.id; })
      .attr("d", path)
      .style("fill", function (d) {
            // Lookup country in dictionary with values
            countryValue = dictCountries[d.id];
            // If there is data for the country give a fill
            if (countryValue)
              return colorMap(countryValue);
          })
      // Tooltip
      .on('mousemove', function(d) {
          var mouse = d3.mouse( svg.node() ).map(function(d) { return parseInt(d); });
          
          tooltip.classed('hidden', false)
              .attr('style', 'left:' + (mouse[0] + 15) +'px; top:' + (mouse[1] + 20) + 'px')
              .html("<strong>" + d.id + "</strong>" + "<br>" + (dictCountries[d.id] * 1000).toLocaleString() + " bbl/day");
      })
      .on('mouseout', function() { tooltip.classed('hidden', true);})
      .on("click", function() {
          country = this.id;
          d3.selectAll("#" + country)
              .style("fill", "red");
          updateTreemap(country, year, trade);
        });
    
  /*------ MAP LEGEND ----*/
    var legend = svg.append("g")
        .attr("class", "key")
        .attr("transform", "translate(0,40)");

    // legend.selectAll("rect")
    //   .data(colorMap.range().map(function(d) {
    //       d = colorMap.invertExtent(d);
    //       if (d[0] == null) d[0] = x.domain()[0];
    //       if (d[1] == null) d[1] = x.domain()[1];
    //       return d;
    //     }))
    //   .enter().append("rect")
    //     .attr("height", 8)
    //     .attr("x", function(d) { return x(d[0]); })
    //     .attr("width", function(d) { return x(d[1]) - x(d[0]); })
    //     .attr("fill", function(d) { return color(d[0]); });

    // legend.append("text")
    //     .attr("class", "caption")
    //     .attr("x", x.range()[0] / 2)
    //     .attr("y", -6)
    //     .attr("fill", "#000")
    //     .attr("text-anchor", "start")
    //     .attr("font-weight", "bold")
    //     .text("1000 bbl/day");

    // legend.call(d3.axisBottom(x)
    //     .tickSize(13)
    //     .tickFormat(function(x, i) { return i ? x : x; })
    //     .tickValues(colorMap.domain()))
    //   .select(".domain")
    //     .remove();

  // Update when toggle is switched or year is changed
  function updateMap(tradedata, selectedYear) {
    // console.log("selectedYear", selectedYear)
    
    // Empty the dictionary
    dictCountries = {}

    // Make new dictionary with appropriate data
    tradedata[selectedYear].forEach(function (d) { dictCountries[d.country] = d.value }); // Beetje dubbel werk

    // Recolour the map
    d3.selectAll(".country")
      .style("fill", function (d) {
        // Lookup country in dictionary with values
        var countryValue = dictCountries[d.id];

        // If there is data for the country give a fill
        if (countryValue)
          return colorMap(countryValue);
      })

  function MatchCountrycode(countrycode) {
    var countrycodesDict = {
      "AFG": "Afghanistan",
      "ALB": "Albania",
      "DZA": "Algeria",
      "ASM": "American Samoa",
      "AND": "Andorra",
      "AGO": "Angola",
      "AIA": "Anguilla",
      "ATA": "Antarctica",
      "ATG": "Antigua and Barbuda",
      "ARG": "Argentina",
      "ARM": "Armenia",
      "ABW": "Aruba",
      "AUS": "Australia",
      "AUT": "Austria",
      "AZE": "Azerbaijan",
      "BHS": "Bahamas",
      "BHR": "Bahrain",
      "BGD": "Bangladesh",
      "BRB": "Barbados",
      "BLR": "Belarus",
      "BEL": "Belgium",
      "BLZ": "Belize",
      "BEN": "Benin",
      "BMU": "Bermuda",
      "BTN": "Bhutan",
      "BOL": "Bolivia",
      "BES": "Bonaire",
      "BIH": "Bosnia and Herzegovina",
      "BWA": "Botswana",
      "BVT": "Bouvet Island",
      "BRA": "Brazil",
      "IOT": "British Indian Ocean Territory",
      "BRN": "Brunei Darussalam",
      "BGR": "Bulgaria",
      "BFA": "Burkina Faso",
      "BDI": "Burundi",
      "KHM": "Cambodia",
      "CMR": "Cameroon",
      "CAN": "Canada",
      "CPV": "Cape Verde",
      "CYM": "Cayman Islands",
      "CAF": "Central African Republic",
      "TCD": "Chad",
      "CHL": "Chile",
      "CHN": "China",
      "COL": "Colombia",
      "COM": "Comoros",
      "COG": "Republic of Congo",
      "COD": "Congo",
      "COK": "Cook Islands",
      "CRI": "Costa Rica",
      "CIV": "Côte dIvoire",
      "HRV": "Croatia",
      "CUB": "Cuba",
      "CUW": "Curaçao",
      "CYP": "Cyprus",
      "CZE": "Czech Republic",
      "DNK": "Denmark",
      "DJI": "Djibouti",
      "DMA": "Dominica",
      "DOM": "Dominican Republic",
      "ECU": "Ecuador",
      "EGY": "Egypt",
      "SLV": "El Salvador",
      "GNQ": "Equatorial Guinea",
      "ERI": "Eritrea",
      "EST": "Estonia",
      "ETH": "Ethiopia",
      "FLK": "Falkland Islands (Malvinas)",
      "FRO": "Faroe Islands",
      "FJI": "Fiji",
      "FIN": "Finland",
      "FRA": "France",
      "GUF": "French Guiana",
      "PYF": "French Polynesia",
      "ATF": "French Southern Territories",
      "GAB": "Gabon",
      "GMB": "Gambia",
      "GEO": "Georgia",
      "DEU": "Germany",
      "GHA": "Ghana",
      "GIB": "Gibraltar",
      "GRC": "Greece",
      "GRL": "Greenland",
      "GRD": "Grenada",
      "GLP": "Guadeloupe",
      "GUM": "Guam",
      "GTM": "Guatemala",
      "GGY": "Guernsey",
      "GIN": "Guinea",
      "GNB": "Guinea-Bissau",
      "GUY": "Guyana",
      "HTI": "Haiti",
      "HMD": "Heard Island and McDonald Islands",
      "VAT": "Vatican City State",
      "HND": "Honduras",
      "HKG": "Hong Kong",
      "HUN": "Hungary",
      "ISL": "Iceland",
      "IND": "India",
      "IDN": "Indonesia",
      "IRN": "Iran",
      "IRQ": "Iraq",
      "IRL": "Ireland",
      "IMN": "Isle of Man",
      "ISR": "Israel",
      "ITA": "Italy",
      "JAM": "Jamaica",
      "JPN": "Japan",
      "JEY": "Jersey",
      "JOR": "Jordan",
      "KAZ": "Kazakhstan",
      "KEN": "Kenya",
      "KIR": "Kiribati",
      "PRK": "North Korea",
      "KOR": "South Korea",
      "KWT": "Kuwait",
      "KGZ": "Kyrgyzstan",
      "LAO": "Laos",
      "LVA": "Latvia",
      "LBN": "Lebanon",
      "LSO": "Lesotho",
      "LBR": "Liberia",
      "LBY": "Libya",
      "LIE": "Liechtenstein",
      "LTU": "Lithuania",
      "LUX": "Luxembourg",
      "MAC": "Macao",
      "MKD": "Macedonia",
      "MDG": "Madagascar",
      "MWI": "Malawi",
      "MYS": "Malaysia",
      "MDV": "Maldives",
      "MLI": "Mali",
      "MLT": "Malta",
      "MHL": "Marshall Islands",
      "MTQ": "Martinique",
      "MRT": "Mauritania",
      "MUS": "Mauritius",
      "MYT": "Mayotte",
      "MEX": "Mexico",
      "FSM": "Micronesia",
      "MDA": "Moldova",
      "MCO": "Monaco",
      "MNG": "Mongolia",
      "MNE": "Montenegro",
      "MSR": "Montserrat",
      "MAR": "Morocco",
      "MOZ": "Mozambique",
      "MMR": "Myanmar",
      "NAM": "Namibia",
      "NRU": "Nauru",
      "NPL": "Nepal",
      "NLD": "Netherlands",
      "NCL": "New Caledonia",
      "NZL": "New Zealand",
      "NIC": "Nicaragua",
      "NER": "Niger",
      "NGA": "Nigeria",
      "NIU": "Niue",
      "NFK": "Norfolk Island",
      "MNP": "Northern Mariana Islands",
      "NOR": "Norway",
      "OMN": "Oman",
      "PAK": "Pakistan",
      "PLW": "Palau",
      "PSE": "Palestine",
      "PAN": "Panama",
      "PNG": "Papua New Guinea",
      "PRY": "Paraguay",
      "PER": "Peru",
      "PHL": "Philippines",
      "PCN": "Pitcairn",
      "POL": "Poland",
      "PRT": "Portugal",
      "PRI": "Puerto Rico",
      "QAT": "Qatar",
      "REU": "Réunion",
      "ROU": "Romania",
      "RUS": "Russian Federation",
      "RWA": "Rwanda",
      "KNA": "Saint Kitts and Nevis",
      "LCA": "Saint Lucia",
      "MAF": "Saint Martin (French part)",
      "SPM": "Saint Pierre and Miquelon",
      "VCT": "Saint Vincent and the Grenadines",
      "WSM": "Samoa",
      "SMR": "San Marino",
      "STP": "Sao Tome and Principe",
      "SAU": "Saudi Arabia",
      "SEN": "Senegal",
      "SRB": "Serbia",
      "SYC": "Seychelles",
      "SLE": "Sierra Leone",
      "SGP": "Singapore",
      "SXM": "Sint Maarten (Dutch part)",
      "SVK": "Slovakia",
      "SVN": "Slovenia",
      "SLB": "Solomon Islands",
      "SOM": "Somalia",
      "ZAF": "South Africa",
      "SGS": "South Georgia and the South Sandwich Islands",
      "SSD": "South Sudan",
      "ESP": "Spain",
      "LKA": "Sri Lanka",
      "SDN": "Sudan",
      "SUR": "Suriname",
      "SJM": "Svalbard and Jan Mayen",
      "SWZ": "Swaziland",
      "SWE": "Sweden",
      "CHE": "Switzerland",
      "SYR": "Syrian Arab Republic",
      "TWN": "Taiwan",
      "TJK": "Tajikistan",
      "TZA": "Tanzania",
      "THA": "Thailand",
      "TLS": "Timor-Leste",
      "TGO": "Togo",
      "TKL": "Tokelau",
      "TON": "Tonga",
      "TTO": "Trinidad and Tobago",
      "TUN": "Tunisia",
      "TUR": "Turkey",
      "TKM": "Turkmenistan",
      "TCA": "Turks and Caicos Islands",
      "TUV": "Tuvalu",
      "UGA": "Uganda",
      "UKR": "Ukraine",
      "ARE": "United Arab Emirates",
      "GBR": "United Kingdom",
      "USA": "United States",
      "UMI": "United States Minor Outlying Islands",
      "URY": "Uruguay",
      "UZB": "Uzbekistan",
      "VUT": "Vanuatu",
      "VEN": "Venezuela",
      "VNM": "Viet Nam",
      "VGB": "Virgin Islands",
      "VIR": "Virgin Islands",
      "WLF": "Wallis and Futuna",
      "ESH": "Western Sahara",
      "YEM": "Yemen",
      "ZMB": "Zambia",
      "ZWE": "Zimbabwe",
    }

  }

  }
}

</script>

</body>

</html>